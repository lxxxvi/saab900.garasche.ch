require 'test_helper'

class UploadsControllerTest < ActionDispatch::IntegrationTest
  test 'uploads image' do
    file = fixture_file_upload('image.png')

    assert_difference -> { Upload.count }, 1 do
      post uploads_path, params: { upload: { file: file } }
    end

    follow_redirect!
    assert_response :success
    assert_equal 'Upload erfolgreich', flash[:success]
  end

  test 'uploads pdf' do
    file = fixture_file_upload('pdf.pdf')

    assert_difference -> { Upload.count }, 1 do
      post uploads_path, params: { upload: { file: file } }
    end
  end

  test 'uploads nothing' do
    assert_no_difference -> { Upload.count } do
      post uploads_path, params: { upload: { file: nil } }
    end

    follow_redirect!
    assert_response :success
    assert_equal 'Irgendwas hat nicht geklappt, versuchs nochmal ;-)', flash[:alert]
  end

  test 'uploads unsupported file format' do
    file = fixture_file_upload('docx.docx')

    assert_no_difference -> { Upload.count } do
      post uploads_path, params: { upload: { file: file } }
    end
  end

  private
  

  def assert_success
    follow_redirect!
    assert_response :success
    assert_equal 'Upload erfolgreich', flash[:success]
  end

  def assert_alert
    follow_redirect!
    assert_response :success
    assert_equal 'Irgendwas hat nicht geklappt, versuchs nochmal ;-)', flash[:alert]
  end
end
